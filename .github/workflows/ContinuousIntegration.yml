name: Continuous Integration

on: [push]

jobs:
  lint-compile-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup node env âš™ï¸
        uses: actions/setup-node@v2.1.4
        with:
          node-version: 16

      - name: Setup database ğŸ—„ï¸
        uses: harmon758/postgresql-action@v1
        with:
          postgresql version: '13.0-alpine'
          postgresql db: 'psql'
          postgresql user: 'psql'
          postgresql password: 'psql'

      - name: Install lerna â¬‡ï¸
        run: npm install --global lerna

      - name: Checkout ğŸ›
        uses: actions/checkout@main

      - name: Cache node_modules ğŸ“¦
        uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}    
          restore-keys: |
            ${{ runner.os }}-modules-                                   

      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run:  lerna bootstrap

      - name: Run compile ğŸ—
        run: make compile 

      - name: Run linter ğŸ‘€
        run: make format      

      - name: Run tests ğŸ§ª
        run: make test
                
      - name: Upload coverage â¬†ï¸
        run: npx codecov --token=${{ secrets.CODECOV_TOKEN }}            

  e2e-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: ['firefox','chrome']

    steps:
      - name: Setup node env âš™ï¸
        uses: actions/setup-node@v2.1.4
        with:
          node-version: 16

      - name: Setup database ğŸ—„ï¸
        uses: harmon758/postgresql-action@v1
        with:
          postgresql version: '13.0-alpine'
          postgresql db: 'psql'
          postgresql user: 'psql'
          postgresql password: 'psql'      

      - name: Update Chrome â¬‡ï¸
        if: ${{ matrix.browser == 'chrome' }}
        run: |
          sudo sh -c 'echo "deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list'
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo apt update
          sudo apt-get install google-chrome-stable
      
      - name: Install lerna â¬‡ï¸
        run: npm install --global lerna

      - name: Checkout ğŸ›
        uses: actions/checkout@main

      - name: Cache node_modules ğŸ“¦
        uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}    
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: Install dependencies ğŸ‘¨ğŸ»â€ğŸ’»
        run:  lerna bootstrap

      - name: Make envfile âš™ï¸
        run: | 
          touch .env        
          echo 'ENDPOINT="http://localhost:8000"' >> .env
          mv .env ./packages/client

      - name: Run compile ğŸ—
        run: make compile 

      - name: Setup database table ğŸ—„ï¸
        run: make import

      - name: Start api ğŸ—
        run: |
          lerna run --scope '@cph-scorer/api' build
          lerna run --scope '@cph-scorer/api' start &

      - name: Start client ğŸ—
        run: |          
          lerna run --scope '@cph-scorer/client' build
          cd packages/client/dist; python3 -m "http.server" 1234 & 

      - name: Run e2e tests ğŸ§ª
        run: make e2e-test BROWSER=${{ matrix.browser }}

